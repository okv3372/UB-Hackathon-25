@inherits LayoutComponentBase
@using SmartStudy.Components.Shared
@using SmartStudy.Components.Pages.Class
@using SmartStudy.Services
@using SmartStudy.Models
@inject SmartStudy.Services.BreadcrumbService Breadcrumbs
@inject NavigationManager Nav
@implements IDisposable

<div class="page">
    <header class="app-header">
        <h1 class="brand">
            <img src="/images/whiteCompanyLogo.png" alt="SmartStudy Logo" style="width:35px;height:auto;vertical-align:middle;" />
            SmartStudy
        </h1>
        <div class="header-actions">
            <button class="logout-btn" title="Log out" @onclick="Logout">
                <span class="logout-label">Logout</span>
            </button>
            <button class="profile-btn" title="Open profile" @onclick="OpenProfileFromHeader">
                <span class="profile-label">Profile</span>
            </button>
        </div>
    </header>

    <main style="width:100%">
        <article class="content px-4">
            @* Breadcrumbs placed here so they appear on top of each page *@
            <Breadcrumbs Items="@_crumbs" />
            @Body
        </article>
    </main>
</div>

@* Place the modal once at layout-level so it can be opened from the header *@
<ProfileModal @ref="_profileModal" EnableEditButton="true" />

@code {
    private List<SmartStudy.Services.BreadcrumbItem> _crumbs = new();
    private ProfileModal? _profileModal;

    protected override async Task OnInitializedAsync()
    {
        await RefreshCrumbsAsync();
        Nav.LocationChanged += OnLocationChanged;
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        await RefreshCrumbsAsync(e.Location);
        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Rebuild breadcrumbs using service rules:
    /// - First crumb is always "Home" ("/")
    /// - No "/Class" dead link; "Class List" points to "/{userId}/ClassList"
    /// - Avoid duplicate "Student" crumbs when navigating into assignments
    /// </summary>
    private async Task RefreshCrumbsAsync(string? location = null)
    {
        // Await the async breadcrumb building (resolves class name lookups)
        var items = await Breadcrumbs.GetBreadcrumbsFromUri(location);
        items ??= new List<SmartStudy.Services.BreadcrumbItem>();

        if (items.Count == 0)
        {
            items.Add(new SmartStudy.Services.BreadcrumbItem
            {
                Label = "Home",
                Url = "/",
                IsCurrent = true
            });
        }

        _crumbs = items;
    }

    private void OpenProfileFromHeader()
    {
        try
        {
            var uri = new Uri(Nav.Uri);
            var segments = uri.AbsolutePath.Trim('/').Split('/', StringSplitOptions.RemoveEmptyEntries);
            var userId = segments.Length > 0 ? segments[0] : null;

            if (_profileModal is null)
            {
                return;
            }

            if (!string.IsNullOrWhiteSpace(userId))
            {
                var profile = ProfileService.GetProfile(userId);
                if (profile is not null)
                {
                    _profileModal.OpenForUser(profile);
                    return;
                }
            }

            // Fallback: open empty modal if userId or profile is missing
            _profileModal.OpenModal();
        }
        catch
        {
            _profileModal?.OpenModal();
        }
    }

    private void Logout()
    {
        // For hackathon demo: simply navigate to home route. If auth state existed, we'd clear it here.
        Nav.NavigateTo("/");
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }
}

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

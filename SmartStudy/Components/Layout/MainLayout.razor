@inherits LayoutComponentBase
@using SmartStudy.Components.Shared
@inject SmartStudy.Services.BreadcrumbService Breadcrumbs
@inject NavigationManager Nav
@implements IDisposable

<div class="page">
    <header class="app-header">
        <h1 class="brand">
            <img src="/images/whiteCompanyLogo.png" alt="SmartStudy Logo" style="width:35px;height:auto;vertical-align:middle;" />
            SmartStudy
        </h1>
    </header>

    <main style="width:100%">
        <article class="content px-4">
            @* Breadcrumbs placed here so they appear on top of each page *@
            <Breadcrumbs Items="@_crumbs" />
            @Body
        </article>
    </main>
</div>

@code {
    private List<SmartStudy.Services.BreadcrumbItem> _crumbs = new();

    protected override async Task OnInitializedAsync()
    {
        await RefreshCrumbsAsync();
        Nav.LocationChanged += OnLocationChanged;
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        await RefreshCrumbsAsync(e.Location);
        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Rebuild breadcrumbs using service rules:
    /// - First crumb is always "Home" ("/")
    /// - No "/Class" dead link; "Class List" points to "/{userId}/ClassList"
    /// - Avoid duplicate "Student" crumbs when navigating into assignments
    /// </summary>
    private async Task RefreshCrumbsAsync(string? location = null)
    {
        // Await the async breadcrumb building (resolves class name lookups)
        var items = await Breadcrumbs.GetBreadcrumbsFromUri(location);
        items ??= new List<SmartStudy.Services.BreadcrumbItem>();

        if (items.Count == 0)
        {
            items.Add(new SmartStudy.Services.BreadcrumbItem
            {
                Label = "Home",
                Url = "/",
                IsCurrent = true
            });
        }

        _crumbs = items;
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }
}

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

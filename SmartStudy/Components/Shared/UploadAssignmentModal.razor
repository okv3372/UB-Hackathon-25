@namespace SmartStudy.Components.Shared
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@inject IWebHostEnvironment Env
@inject SmartStudy.API.Services.AssignmentService AssignmentService

@* Fullscreen loading overlay shown while the model (SK) is being called *@
<div class="loading-overlay" style="display:@(IsLoadingModel ? "flex" : "none")">
    <div class="spinner"></div>
    <div class="loading-text">Generating practice set...</div>
    <small class="loading-sub">Analyzing the file & creating questions</small>
</div>

@* Snackbar notification *@
<div class="snackbar @SnackbarStyle" style="display:@(ShowSnackbar ? "block" : "none")">
    @SnackbarMessage
</div>

<div class="upload-modal-backdrop" style="display:@(IsOpen ? "flex" : "none")">
    <div class="upload-modal">
        <div class="modal-header d-flex align-items-center">
            <div class="avatar-placeholder me-3" style="background-image: url('@(ProfileImageUrl ?? "/favicon.png")')"></div>
            <div>
                <h4 class="mb-0">Upload Assignment</h4>
                <small class="text-muted">for <strong>@(StudentName ?? TargetUserId ?? "Student")</strong> • Class: <span class="class-pill">@(ClassId ?? "—")</span></small>
            </div>
            <button class="btn-close ms-auto" aria-label="Close" @onclick="CloseModal"></button>
        </div>

        <div class="modal-body mt-3">

            <div class="mb-3">
                <label class="form-label">Title</label>
                <input class="form-control form-control-lg pretty-input" @bind="Title" placeholder="Assignment title (e.g., Lab 1)" />
            </div>

            <div class="mb-3">
                <label class="form-label">Comments (optional)</label>
                <textarea class="form-control pretty-textarea" rows="3" @bind="TeacherComments" placeholder="Notes for the assignment"></textarea>
            </div>

            <div class="file-dropzone mb-2" tabindex="0">
                <div class="dz-inner">
                    <i class="bi bi-upload" style="font-size:1.6rem"></i>
                    <div class="dz-text">Drag & drop a file here or click to browse</div>
                    <div class="dz-sub">Accepted: PDF, DOCX, PNG, JPG — Max 50MB</div>
                    <InputFile OnChange="OnInputFileChange" />
                </div>
            </div>

            @if (!string.IsNullOrEmpty(SelectedFileName))
            {
                <div class="selected-file mb-2">Selected: <strong>@SelectedFileName</strong></div>
            }

            @if (!string.IsNullOrEmpty(StatusMessage))
            {
                <div class="alert alert-info">@StatusMessage</div>
            }
        </div>

        <div class="modal-footer d-flex justify-content-end mt-3">
            <button class="btn btn-outline-secondary me-2" @onclick="CloseModal">Cancel</button>
            <button class="btn btn-primary btn-lg" @onclick="UploadAsync" disabled="@(!CanUpload)">Upload Assignment</button>
        </div>
    </div>
</div>

<style>
    .upload-modal-backdrop {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.45);
        z-index: 1050;
    }
    .upload-modal {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 520px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 12px;
        background: rgba(255,255,255,0.85);
        z-index: 2000; /* above modal */
        color: #1f2937;
        text-align: center;
    }
    .spinner {
        width: 64px; height: 64px;
        border: 6px solid #e5e7eb;
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    .loading-text { font-weight: 600; margin-top: 8px; }
    .loading-sub { color:#6b7280; }
    @@keyframes spin { to { transform: rotate(360deg); } }

    /* Snackbar */
    .snackbar {
        position: fixed;
        left: 50%;
        bottom: 28px;
        transform: translateX(-50%);
        background: #111827;
        color: #fff;
        padding: 12px 18px;
        border-radius: 10px;
        box-shadow: 0 6px 24px rgba(0,0,0,0.18);
        z-index: 2100;
        max-width: 90vw;
        white-space: pre-wrap;
    }
    .snackbar.success { background:#16a34a; }
    .snackbar.error { background:#dc2626; }

    .avatar-placeholder {
        width:56px; height:56px;
        background-size:cover; background-position:center;
        border-radius:12px;
        box-shadow:0 4px 12px rgba(0,0,0,0.08);
    }

    .class-pill {
        background:#f1f6ff;
        color:#1a659e;
        padding:2px 8px;
        border-radius:999px;
        font-size:0.85em;
    }

    .file-dropzone {
        border:2px dashed #dbeafe;
        border-radius:8px;
        padding:18px;
        text-align:center;
        cursor:pointer;
        background:#fbfdff;
        position: relative;
        overflow: hidden;
    }
    .file-dropzone .dz-inner {
        display:flex; flex-direction:column; align-items:center; gap:6px;
    }
    .file-dropzone input[type=file] {
        opacity:0;
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
        cursor:pointer;
        z-index:5;
    }

    .form-label {
        font-weight: 500;
        color: #2d3d50;
    }

    .pretty-input, .pretty-textarea {
        border-radius: 10px;
        background: #fafcff;
        border: 1px solid #d8e3ef;
        transition: border-color .2s, box-shadow .2s, background .2s;
    }
    .pretty-input:focus, .pretty-textarea:focus {
        border-color: #6aa7ff;
        box-shadow: 0 0 0 3px rgba(106,167,255,0.25);
        background: #ffffff;
    }
</style>

@code {
    [Parameter] public string? TargetUserId { get; set; }
    [Parameter] public string? ClassId { get; set; }
    [Parameter] public EventCallback<SmartStudy.Models.AssignmentDTO> OnUploaded { get; set; }
    [Parameter] public string? StudentName { get; set; }
    [Parameter] public string? ProfileImageUrl { get; set; }
    // The user performing the upload (e.g., teacher); used as TeacherId
    [Parameter] public string? TeacherId { get; set; }

    private IBrowserFile? selectedFile;
    private string SelectedFileName = string.Empty;
    private bool IsOpen = false;
    private string StatusMessage = string.Empty;
    private string Title = string.Empty;
    private string TeacherComments = string.Empty;

    // Loading & snackbar state
    private bool IsLoadingModel = false;
    private bool ShowSnackbar = false;
    private string SnackbarMessage = string.Empty;
    private string SnackbarStyle = "success"; // or "error"

    public void OpenModal()
    {
        IsOpen = true;
        StateHasChanged();
    }

    public void CloseModal()
    {
        IsOpen = false;
        selectedFile = null;
        SelectedFileName = string.Empty;
        StatusMessage = string.Empty;
        StateHasChanged();
    }

    private void OnInputFileChange(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        SelectedFileName = selectedFile?.Name ?? string.Empty;
        StatusMessage = string.Empty;
    }

    private bool CanUpload => selectedFile != null;

    private async Task UploadAsync()
    {
        if (selectedFile == null)
        {
            StatusMessage = "No file selected.";
            return;
        }

        try
        {
            var uploadsDir = Path.Combine(Env.ContentRootPath, "wwwroot", "uploads");
            if (!Directory.Exists(uploadsDir))
                Directory.CreateDirectory(uploadsDir);

            var safeFileName = Path.GetFileName(selectedFile.Name).Replace("\n", "_").Replace("\r", "_");
            var filePath = Path.Combine(uploadsDir, $"{Guid.NewGuid():N}_{safeFileName}");

            using (var fs = new FileStream(filePath, FileMode.Create, FileAccess.Write, FileShare.Read))
            {
                await selectedFile.OpenReadStream(50 * 1024 * 1024).CopyToAsync(fs);
            }

            StatusMessage = "File uploaded successfully.";

            Console.WriteLine("Uploading assignment with file path: " + filePath);

            // Show loading overlay while the model generates a practice set
            IsLoadingModel = true;
            StateHasChanged();

            // Call central AssignmentService to add and persist the assignment (service handles JSON write & practice set generation)
            var dto = await AssignmentService.AddAssignmentAsync(
                studentId: TargetUserId ?? string.Empty,
                teacherId: TeacherId ?? string.Empty,
                classId: ClassId ?? string.Empty,
                filePath: filePath,
                teacherComment: TeacherComments ?? string.Empty,
                title: Title ?? string.Empty);

            // Hide loading overlay and show success snackbar
            IsLoadingModel = false;
            SnackbarStyle = "success";
            SnackbarMessage = "Assignment uploaded and practice set ready.";
            ShowSnackbar = true;
            _ = HideSnackbarSoon();

            if (OnUploaded.HasDelegate)
                await OnUploaded.InvokeAsync(dto);

            await Task.Delay(600);
            CloseModal();
        }
        catch (Exception ex)
        {
            IsLoadingModel = false;
            StatusMessage = $"Upload failed: {ex.Message}";
            SnackbarStyle = "error";
            SnackbarMessage = $"Upload failed: {ex.Message}";
            ShowSnackbar = true;
            _ = HideSnackbarSoon();
        }
    }

    private async Task HideSnackbarSoon()
    {
        try { await Task.Delay(3500); }
        catch { }
        ShowSnackbar = false;
        StateHasChanged();
    }
}
